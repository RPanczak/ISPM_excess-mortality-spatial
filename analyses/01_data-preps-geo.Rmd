---
title: "Spatial analyses of 2020-21 excess mortality in CH"
subtitle: "Geodata preparation"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show 
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, readxl, magrittr, 
       scales, janitor, lubridate, DT,
       sf, tmap)

import::from("sjmisc", "frq")
```


```{r conflicts, include = FALSE}
tidyverse::tidyverse_conflicts()

conflicted::conflict_scout()
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Data sources 

## BfS data 2021 {.tabset}

[Generalisierte Gemeindegrenzen: Geodaten](https://www.bfs.admin.ch/bfs/de/home/dienstleistungen/geostat/geodaten-bundesstatistik/administrative-grenzen/generalisierte-gemeindegrenzen.assetdetail.17964056.html).  

Contains three versions of data:  

> "Generalisierte Gemeindegrenzen, Stand 01.01.2021 & 18.04.2021 & 01.07.2021"	

Currently using `01.07` edition.  

```{r eval=FALSE}
download.file(url = "https://www.bfs.admin.ch/bfsstatic/dam/assets/17964056/master",
              destfile = "data-raw/BfS/ag-b-00.03-875-gg21.zip",
              method = "curl")

unzip("data-raw/BfS/ag-b-00.03-875-gg21.zip", exdir = "data-raw/BfS/ag-b-00.03-875-gg21")

unlink("data-raw/BfS/ag-b-00.03-875-gg21.zip")
unlink("data-raw/BfS/ag-b-00.03-875-gg21/txt", recursive = TRUE)
unlink("data-raw/BfS/ag-b-00.03-875-gg21/kmz", recursive = TRUE)
unlink("data-raw/BfS/ag-b-00.03-875-gg21/ggg_2021-LV03", recursive = TRUE)
unlink("data-raw/BfS/ag-b-00.03-875-gg21/ggg_2021-LV95/ggg_2021-LV95.gdb", recursive = TRUE)
```

```{r}
gg21 <- 
  st_read("data-raw/BfS/ag-b-00.03-875-gg21/ggg_2021-LV95/shp/g1g21_01072021.shp",
          as_tibble = TRUE) %>% 
  st_set_crs(2056)

bz21 <- 
  st_read("data-raw/BfS/ag-b-00.03-875-gg21/ggg_2021-LV95/shp/g1b21.shp",
          as_tibble = TRUE) 

kt21 <- 
  st_read("data-raw/BfS/ag-b-00.03-875-gg21/ggg_2021-LV95/shp/g1k21.shp",
          as_tibble = TRUE) 

se21 <- 
  st_read("data-raw/BfS/ag-b-00.03-875-gg21/ggg_2021-LV95/shp/g1s21.shp",
          as_tibble = TRUE) 

write_rds(bz21, "data/BfS/bz21.Rds")
write_rds(kt21, "data/BfS/kt21.Rds")
write_rds(se21, "data/BfS/se21.Rds")
```

### Canton 

```{r echo=FALSE}
tm_shape(se21, is.master = FALSE) +
  tm_fill() + 
  tm_shape(kt21) +
  tm_borders()
```

### District 

```{r echo=FALSE}
tm_shape(se21, is.master = FALSE) +
  tm_fill() + 
  tm_shape(bz21) +
  tm_borders()
```

### Community 

```{r echo=FALSE}
tm_shape(se21, is.master = FALSE) +
  tm_fill() + 
  tm_shape(gg21) +
  tm_borders()
```

## swisstopo data 2021

`swissBOUNDARIES3D` data available from [here](https://www.swisstopo.admin.ch/de/geodata/landscape/boundaries3d.html). Also exist for XX July versions.  

```{r eval=FALSE}
download.file(url = "https://data.geo.admin.ch/ch.swisstopo.swissboundaries3d/swissboundaries3d_2021-07/swissboundaries3d_2021-07_2056_5728.shp.zip",
              destfile = "data-raw/swisstopo/swissboundaries3d_2021-07_2056_5728.shp.zip",
              method = "curl")

unzip("data-raw/swisstopo/swissboundaries3d_2021-07_2056_5728.shp.zip", 
      exdir = "data-raw/swisstopo/swissboundaries3d_2021-07_2056_5728")

unlink("data-raw/swisstopo/swissboundaries3d_2021-01_2056_5728.shp.zip")
```

```{r}
st_gg21 <- 
  st_read("data-raw/swisstopo/swissboundaries3d_2021-07_2056_5728/SHAPEFILE_LV95_LN02/swissBOUNDARIES3D_1_3_TLM_HOHEITSGEBIET.shp",
          as_tibble = TRUE) %>% 
  st_zm(drop = TRUE, what = "ZM")

# st_bz21 <- 
#   st_read("data-raw/swisstopo/swissboundaries3d_2021-07_2056_5728/SHAPEFILE_LV95_LN02/swissBOUNDARIES3D_1_3_TLM_BEZIRKSGEBIET.shp",
# as_tibble = TRUE) %>% 
# st_zm(drop = TRUE, what = "ZM")

st_kt21 <- 
  st_read("data-raw/swisstopo/swissboundaries3d_2021-07_2056_5728/SHAPEFILE_LV95_LN02/swissBOUNDARIES3D_1_3_TLM_KANTONSGEBIET.shp",
          as_tibble = TRUE) %>% 
  st_zm(drop = TRUE, what = "ZM")

# write_rds(st_bz21, "data/swisstopo/st_bz21.Rds")
write_rds(st_kt21, "data/swisstopo/st_kt21.Rds")
```

## Important differences

### Resolution

swisstopo borders (in blue below) offer better resolution and will be used for certain spatial operations (like linking to SEP) whereas BfS data are smaller in size and easier to plot. Example of Bern:  

```{r echo=FALSE}
tm_shape(st_gg21 %>% filter(BFS_NUMMER == 351)) +
  tm_borders(col = "blue", lwd = 1, alpha = 0.5) +
  tm_shape(gg21 %>% filter(GMDNR == 351)) +
  tm_borders(col = "red", lwd = 2, alpha = 0.5) +
  tm_layout(
    title = "Different spatial resolutions"
  )
```

### Water bodies

Additionally datasets differ in terms of conceptualization of the boundaries of water bodies. BfS data reach the shore of the lake, whereas swisstopo extends them over lakes.  

```{r echo=FALSE}
tm_shape(se21 %>% filter(GMDNR == 9151), is.master = FALSE) +
  tm_fill(col = "gray", alpha = 0.5) +
  tm_shape(st_gg21 %>% filter(BFS_NUMMER == 2051), is.master = TRUE) +
  tm_borders(col = "blue", lwd = 1, alpha = 0.5) +
  tm_shape(gg21 %>% filter(GMDNR == 2051)) +
  tm_borders(col = "red", lwd = 2, alpha = 0.5) +
  tm_layout(
    title = "Different lake boundaries"
  )
```

### Multipart features

BfS stores data as `MULTIPOLYGON` 

```{r echo=FALSE}
gg21 %>% 
  filter(GMDNR == 6153) %>% 
  select(GMDNR) %>% 
  plot()
```

whereas swisstopo as `POLYGON`.  In such case community Monthey will be represented as four rows of data (individual polygons) instead of one.  

```{r echo=FALSE}
st_gg21 %>% 
  filter(BFS_NUMMER == 6153) %>%
  select(GEM_TEIL) %>% 
  plot()
```

That might have some implications in terms of spatial operations (maybe contiguity too?).  Data could be converted between types if needed. 

```{r eval=FALSE, include=FALSE}
# if conversion is needed
st_gg21 %>% 
  group_by(BFS_NUMMER) %>% 
  summarise(BFS_NUMMER = first(BFS_NUMMER)) %>%
  st_cast("MULTIPOLYGON") 
```

<!-- ----------------------------------------------------- -->

# Preparations

## Non-residential communities

Excluding `Staatswald Galm`, `Comunanza Cadenazzo/Monteceneri` & `Comunanza Capriasca/Lugano`.  

```{r}
gg21 %>% 
  st_drop_geometry() %>% 
  filter(GMDNR %in% c(2391, 5391, 5394)) %>% 
  select(GMDNAME)
```

```{r include=FALSE}
gg21 %<>% 
  filter(!GMDNR %in% c(2391, 5391, 5394)) %>% 
  select(GMDNR, GMDNAME, BZNR, KTNR) %>% 
  arrange(GMDNR)

st_gg21 %<>% 
  filter(!BFS_NUMMER %in% c(2391, 5391, 5394)) %>% 
  # exclude lakes
  filter(OBJEKTART != "Kantonsgebiet") %>% 
  # exclude FL & enclaves
  filter(ICC == "CH") %>% 
  select(BFS_NUMMER, NAME, BEZIRKSNUM, KANTONSNUM, GEM_TEIL) %>% 
  rename(GMDNR = BFS_NUMMER,
         GMDNAME = NAME,
         BZNR = BEZIRKSNUM,
         KTNR = KANTONSNUM) %>% 
  arrange(GMDNR)
```

```{r eval=FALSE}
# should be exact overlap
gg21 %>%
  filter(! GMDNR %in% st_gg21$GMDNR) %>% 
  nrow()

st_gg21 %>%
  filter(! GMDNR %in% gg21$GMDNR) %>% 
  nrow()
```

```{r}
write_rds(gg21, "data/BfS/gg21.Rds")
write_rds(st_gg21, "data/swisstopo/st_gg21.Rds")
```

## Arbeitsmarktregionen 2018

### Data sources 

More info [here](https://www.bfs.admin.ch/bfs/de/home/aktuell/neue-veroeffentlichungen.gnpdetail.2019-0439.html).  

```{r}
raum <- read_xlsx("data-raw/BfS/Raumgliederungen.xlsx", 
                  skip = 1) %>% 
  remove_empty(c("rows", "cols")) %>% clean_names() %>% 
  filter(! is.na(bfs_gde_nummer)) %>% 
  rename(GMDNR = bfs_gde_nummer,
         KTNAME = kanton,
         BZNAME = bezirksname,
         ARGRNR = arbeitsmarktgrossregionen_2018,
         ARNR = arbeitsmarktregionen_2018) %>% 
  select(GMDNR, KTNAME, BZNAME, 
         ARGRNR, ARNR) %>% 
  left_join(
    read_xlsx("data-raw/BfS/Raumgliederungen.xlsx", 
              skip = 1, sheet = "CH1+CL_GBAE+2018.0") %>% 
      rename(
        ARGRNR = Code,
        ARGRNAME = Label)
  ) %>% 
  left_join(
    read_xlsx("data-raw/BfS/Raumgliederungen.xlsx", 
              skip = 1, sheet = "CH1+CL_BAE+2018.0") %>% 
      rename(
        ARNR = Code,
        ARNAME = Label) 
  ) %>% 
  relocate(ARGRNAME, .after = ARGRNR) %>% 
  relocate(ARNAME, .after = ARNR) %>% 
  mutate(border = if_else(ARNAME %in% c("Schaffhausen", "Basel", 
                                        "Delémont", "Porrentruy", "Saignelégier–Le Noirmont", "La Chaux-de-Fonds",
                                        "Le Chenit", "Genève",
                                        "Locarno", "Lugano"), 
                          1, 0))

write_rds(raum, "data/BfS/AR.Rds")
```

### Preps

List of regions was merged on the basis of community number and then these communities were aggregated.  

```{r}
argr_21 <- gg21 %>% 
  left_join(raum) %>% 
  group_by(ARGRNR) %>% 
  summarise(ARGRNR = first(ARGRNR),
            ARGRNAME = first(ARGRNAME)) %>%
  st_cast("MULTIPOLYGON") 

ar_21 <- gg21 %>% 
  left_join(raum) %>% 
  group_by(ARNR) %>% 
  summarise(ARNR = first(ARNR),
            ARNAME = first(ARNAME),
            border = first(border)) %>%
  st_cast("MULTIPOLYGON") 

st_write(argr_21, "data/geo/argr_21.shp", delete_dsn = TRUE)
st_write(ar_21, "data/geo/ar_21.shp", delete_dsn = TRUE)

# manual corrections in QGIS needed
# st_write(argr_21, "data/geo/argr_21_cor.shp", delete_dsn = TRUE)
# st_write(ar_21, "data/geo/ar_21_cor.shp", delete_dsn = TRUE)
```

```{r include=FALSE}
# same for swisstopo
st_argr_21 <- st_gg21 %>% 
  left_join(raum) %>% 
  group_by(ARGRNR) %>% 
  summarise(ARGRNR = first(ARGRNR),
            ARGRNAME = first(ARGRNAME)) %>%
  st_cast("MULTIPOLYGON") 

st_ar_21 <- st_gg21 %>% 
  left_join(raum) %>% 
  group_by(ARNR) %>% 
  summarise(ARNR = first(ARNR),
            ARNAME = first(ARNAME),
            border = first(border)) %>%
  st_cast("MULTIPOLYGON") 

st_write(st_argr_21, "data/geo/st_argr_21.shp", delete_dsn = TRUE)
st_write(st_ar_21, "data/geo/st_ar_21.shp", delete_dsn = TRUE)

# st_write(st_argr_21, "data/geo/st_argr_21_cor.shp", delete_dsn = TRUE)
# st_write(st_ar_21, "data/geo/st_ar_21_cor.shp", delete_dsn = TRUE)
```

```{r echo=FALSE}
tm_shape(se21, is.master = FALSE) +
  tm_fill(col = "gray", alpha = 0.5) +
  tm_shape(ar_21, is.master = TRUE) +
  tm_borders(col = "blue", lwd = 1, alpha = 0.5) +
  tm_shape(argr_21) +
  tm_borders(col = "red", lwd = 2, alpha = 0.5) +
  tm_layout(
    title = "Regions & grosregions 2021"
  )
```

```{r eval=FALSE, include=FALSE}
tm_shape(se21, is.master = FALSE) +
  tm_fill(col = "gray", alpha = 0.5) +
  tm_shape(st_ar_21, is.master = TRUE) +
  tm_borders(col = "blue", lwd = 1, alpha = 0.5) +
  tm_shape(st_argr_21) +
  tm_borders(col = "red", lwd = 2, alpha = 0.5) +
  tm_layout(
    title = "Regions & grosregions 2021"
  )
```

### Border regions

Defined on the basis of [this map](https://www.bfs.admin.ch/bfs/de/home/aktuell/neue-veroeffentlichungen.assetdetail.8706500.html).  Linked by name of the region since some codes seemed to be out of date? (ie. Basel).  

```{r echo=FALSE}
tm_shape(se21, is.master = FALSE) +
  tm_fill(col = "gray", alpha = 0.5) +
  tm_shape(ar_21) +
  tm_fill(col = "border", lwd = 2, alpha = 0.5, palette = "cat", n = 2,
          legend.show = FALSE) +
  tm_shape(ar_21) +
  tm_borders(col = "white") +
  tm_layout(
    title = "Border regions 2021"
  )
```

```{r echo=FALSE}
ar_21 %>% 
  st_drop_geometry() %>% 
  filter(border == 1) %>%  
  select(-border) %>% 
  datatable() 
```

```{r echo=FALSE}
tm_shape(se21, is.master = FALSE) +
  tm_fill(col = "gray", alpha = 0.5) +
  tm_shape(gg21 %>% left_join(raum)) +
  tm_fill(col = "border", lwd = 2, alpha = 0.5, palette = "cat", n = 2,
          legend.show = FALSE) +
  tm_shape(gg21) +
  tm_borders(col = "white") +
  tm_layout(
    title = "Border communities 2021"
  )
```

```{r echo=FALSE}
gg21 %>% 
  st_drop_geometry() %>% 
  left_join(raum) %>% 
  filter(border == 1) %>%  
  select(GMDNAME, BZNAME, ARGRNAME, ARNAME) %>% 
  datatable() 
```

<!-- ----------------------------------------------------- -->

# Community boundaries mutations

Using `Gemeindestand - Stand vom 01.07.2021.xlsx` from [here](https://www.agvchapp.bfs.admin.ch/de/home) we can identify communities with changes during the study period.  

```{r}
histcomm <- read_xlsx("data-raw/BfS/Mutierte_Gemeinden_20150101_bis_20210701.xlsx", 
                      col_types = c("numeric", "text", "numeric", 
                                    "numeric", "text", "text", "numeric", 
                                    "numeric", "text", "text"), 
                      skip = 1) %>%
  remove_empty(c("rows", "cols")) %>% clean_names() %>% 
  mutate(datum_der_aufnahme = ymd(datum_der_aufnahme)) %>% 
  arrange(desc(datum_der_aufnahme), gemeindename_5) %>% 
  rename(kanton_old = kanton_2,
         bezirks_num_old = bezirks_nummer_3,
         bfs_gde_num_old = bfs_gde_nummer_4,
         gemeindename_old = gemeindename_5,
         kanton_new = kanton_6,
         bezirks_num_new = bezirks_nummer_7,
         bfs_gde_num_new = bfs_gde_nummer_8,
         gemeindename_new = gemeindename_9)

write_rds(histcomm, "data/BfS/histcomm.Rds")
```

There were `r length(unique(histcomm$bezirks_num_old))` communities with changes recorded in `2015-01-01` - `2021-07-01` period.  

Here is list of changes from `2020-01-01` onwards that could affect other data that date for instance refer to  `2020-12-31`:  

```{r echo=FALSE}
histcomm %>% 
  filter(datum_der_aufnahme >= ymd("2021-01-01")) %>% 
  select(-kanton_new, -bezirks_num_old, -bezirks_num_new) %>% 
  datatable()
```

Luckily only few changes occurred after `2021-01-01` and it was a fusion which is easier to handle.  

```{r eval=FALSE, include=FALSE}
# Auf den 18. April 2021 fusionierten die ehemaligen politischen Gemeinden Croglio, Monteggio, Ponte Tresa und Sessa zur neuen politischen Gemeinde Tresa

histcomm %>% 
  filter(bfs_gde_nummer %in% c(5239))

histcomm %>% 
  filter(bfs_gde_nummer %in% c(5178, 5202, 5213, 5222))

gg21 %>% 
  st_drop_geometry() %>% 
  filter(GMDNR %in% c(5239)) %>% 
  select(GMDNR, GMDNAME)

# st_read("data-raw/BfS/ag-b-00.03-875-gg21/ggg_2021-LV95/shp/g1g21_01012021.shp",
#         quiet = TRUE) %>% 
#   st_drop_geometry() %>% 
#   filter(GMDNR %in% c(5178, 5202, 5213, 5222)) %>% 
#   select(GMDNR, GMDNAME)
```

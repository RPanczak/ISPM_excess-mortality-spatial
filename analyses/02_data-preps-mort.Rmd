---
title: "Spatial analyses of 2020-21 excess mortality in CH"
subtitle: "Mortality data preparation"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(fst, tidyverse, magrittr, janitor, scales, lubridate, kableExtra)

import::from("sjmisc", "frq")
```

```{r conflicts, include = FALSE}
tidyverse::tidyverse_conflicts()

conflicted::conflict_scout()
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Mortality data 2015-2021

## Source 

Custom file delivered by BfS covering 2021 period and standardizing communities to Jul 2021. 

```{r eval=FALSE}
deaths_2015_2021 <- read_csv("data-raw/BfS-closed/05OCT21_Lieferung_Panczak.csv", 
                             col_types = cols(year = col_integer(), 
                                              month = col_integer(), 
                                              COUNT = col_integer()),
                             locale = readr::locale(encoding = "latin1")) %>% 
  mutate(sex = if_else(sex == "F", "Female", "Male"),
         nationality = if_else(nationality == "Schweiz", "Swiss", "Foreigner"))
```

```{r}
report::report(deaths_2015_2021)
```

## Age groups

Simplified to `< 40`, `40 - 59` , `60 - 69`, `70 - 79` & `≥ 80`

```{r}
frq(deaths_2015_2021, agegroup)

deaths_2015_2021 %<>% 
  mutate(
    age = case_when(
      agegroup == "[0-10)" ~   "<40",
      agegroup == "[10-20)" ~  "<40",
      agegroup == "[20-30)" ~  "<40",
      agegroup == "[30-40)" ~  "<40",
      
      agegroup == "[40-50)" ~  "40-49",
      agegroup == "[50-60)" ~  "50-59",
      agegroup == "[60-70)" ~  "60-69",
      agegroup == "[70-80)" ~  "70-79",
      
      agegroup == "[80-90)" ~  "80+",
      agegroup == "[90-116)" ~ "80+" ,
      TRUE ~                    agegroup)
    ) %>% 
  select(-agegroup) %>% 
  group_by(year, month, canton, community, sex, age, nationality) %>% 
  summarise(deaths = sum(COUNT)) %>% 
  ungroup()

frq(deaths_2015_2021, age)
```

## Distribution of death counts

Obviously highly skewed. No zeroes here yet! No pop denominator either!  

```{r}
deaths_2015_2021 %>% 
  ggplot(aes(deaths)) + 
  geom_histogram(binwidth = 1)
```

## Filling with zeroes

All possible combinations of `year, month, canton, community, age, sex, nationality` are used and then empty strata are filled with zeroes.  

```{r}
deaths_2015_2021_exp <- deaths_2015_2021 %>% 
  select(-deaths) %>% 
  expand(year, month, canton, community, age, sex, nationality) %>% 
  left_join(deaths_2015_2021) %>% 
  replace_na(list(deaths = 0)) %>% 
  mutate(date = ymd(paste(year, month, "1", sep = " "))) %>% 
  relocate(date, .after = month)
```

That obviously drastically increases the size of the dataset from `r number(nrow(deaths_2015_2021), big.mark = ",")` to `r number(nrow(deaths_2015_2021_exp), big.mark = ",")` with huge amount of zeroes:

```{r}
frq(deaths_2015_2021_exp, deaths == 0)
```

## Examples of time series

```{r}
deaths_2015_2021_exp %>% 
  filter(community %in% c("Zürich", "Bern")) %>% 
  group_by(community, date) %>% 
  summarise(deaths = sum(deaths)) %>% 
  ggplot(aes(x = date, y = deaths, group = community, color = community)) + 
  geom_line() + geom_point()
```

```{r include=FALSE}
write_fst(deaths_2015_2021, "data/BfS-closed/deaths_2015_2021.fst")
write_fst(deaths_2015_2021_exp, "data/BfS-closed/deaths_2015_2021_exp.fst")
```

<!-- ----------------------------------------------------- -->

# Simplification of data

## Removing months


## Aggregating to districts




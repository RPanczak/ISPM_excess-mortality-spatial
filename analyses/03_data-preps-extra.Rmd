---
title: "Spatial analyses of 2020-21 excess mortality in CH"
subtitle: "Ancillary data preparation"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(fst, haven, readxl,
       tidyverse, magrittr, janitor, scales, lubridate, kableExtra,
       sf, tmap)

import::from("sjmisc", "frq")

tmap_mode("view")
```


```{r conflicts, include = FALSE}
tidyverse::tidyverse_conflicts()

conflicted::conflict_scout()
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->
<!-- ----------------------------------------------------- -->

# Population

Data extracted from [`px-x-0103010000_201`](https://www.pxweb.bfs.admin.ch/pxweb/de/px-x-0103010000_201/-/px-x-0103010000_201.px/):

> Ständige und nichtständige Wohnbevölkerung nach institutionellen Gliederungen, Staatsangehörigkeit (Kategorie), Geburtsort, Geschlecht und Altersklasse

Important info from footnotes:

> *Letzte Änderungen: Neuer Datensatz (Jahr 2020)*
> *Stand der Datenbank: Juni 2021*
> *Stichtag: 31. Dezember*
> **Raumbezug: Gemeinden / 18.10.2020**
> *Datenquelle: Statistik der Bevölkerung und der Haushalte STATPOP*
> *Definition der ständigen Wohnbevölkerung*

```{r}
deaths_2015_2021_exp <- read_fst("data/BfS-closed/deaths_2015_2021_exp.fst")


population <- read_xlsx("data-raw/BfS/px-x-0103010000_201.xlsx", 
                        col_types = c("numeric", "skip", "numeric", 
                                      "text", "skip", "skip", "skip", "text", 
                                      "skip", "text", "numeric", "numeric", 
                                      "numeric", "numeric", "numeric", 
                                      "numeric", "numeric", "numeric", 
                                      "numeric", "numeric", "numeric", 
                                      "numeric", "numeric", "numeric", 
                                      "numeric", "numeric", "numeric", 
                                      "numeric", "numeric", "numeric", 
                                      "numeric"), 
                        skip = 1) %>%
  remove_empty(c("rows", "cols")) %>% clean_names() %>% 
  rename(year = x1, 
         GMDNR = x2,
         GMDNAME = x3) %>% 
  mutate(sex = if_else(x5 == "Frau", "Female", "Male"),
         nationality = if_else(x4 == "Schweiz", "Swiss", "Foreigner")) %>% 
  select(-x4, -x5) %>% 
  relocate(sex, .after = GMDNAME) %>% 
  relocate(nationality, .after = sex) %>% 
  mutate(GMDNAME = word(GMDNAME, 2, -1)) %>% 
  fill(year, GMDNR, GMDNAME, nationality) %>% 
  mutate(`<40` = x0_4_jahre + x5_9_jahre + x10_14_jahre + x15_19_jahre + 
           x20_24_jahre + x25_29_jahre + x30_34_jahre + x35_39_jahre) %>% 
  select(-x0_4_jahre, -x5_9_jahre, -x10_14_jahre, -x15_19_jahre,  
         -x20_24_jahre, -x25_29_jahre, -x30_34_jahre, -x35_39_jahre) %>% 
  mutate(`40-49` = x40_44_jahre + x45_49_jahre) %>% 
  mutate(`50-59` = x50_54_jahre + x55_59_jahre) %>% 
  mutate(`60-69` = x60_64_jahre + x65_69_jahre) %>% 
  mutate(`70-79` = x70_74_jahre + x75_79_jahre) %>% 
  select(-x40_44_jahre, -x45_49_jahre, -x50_54_jahre, -x55_59_jahre,
         -x60_64_jahre, -x65_69_jahre, -x70_74_jahre, -x75_79_jahre) %>% 
  mutate(`80+` = x80_84_jahre +x85_89_jahre + x90_94_jahre +
           x95_99_jahre + x100_jahre_und_mehr) %>% 
  select(-x80_84_jahre, -x85_89_jahre, -x90_94_jahre,
         -x95_99_jahre, -x100_jahre_und_mehr) %>% 
  pivot_longer(cols = `<40`:`80+`, 
               names_to = "age", values_to = "population")

write_fst(population, "data/BfS/population.fst")
```

<!-- ----------------------------------------------------- -->

# Cartogram


<!-- ----------------------------------------------------- -->

# Swiss-SEP

```{r}
sep3 <- read_rds("../SNC_Swiss-SEP2/FINAL/RDS/ssep3_user_geo.Rds") %>%
  select(gisid, ssep3, ssep3_d) %>% 
  st_transform(crs = 2056)
# %>%
#   mutate(ssep3_d = factor(ssep3_d,
#                           levels = 1:10,
#                           labels = c("1st - lowest",
#                                      "2", "3", "4",
#                                      "5th decile",
#                                      "6", "7", "8", "9",
#                                      "10th - highest")))
```

Using `r number(nrow(sep3), big.mark = ",")` n'hoods from version 3.0 (hence slightly unequal size of deciles!):  

```{r}
st_drop_geometry(sep3) %>% 
  frq(ssep3_d)
```

```{r include=FALSE}
# prepared in 01.Rmd
gg21 <- read_rds("data/BfS/gg21.Rds")
se21 <- read_rds("data/BfS/se21.Rds")
kt21 <- read_rds("data/BfS/kt21.Rds")

st_gg21 <- read_rds("data/swisstopo/st_gg21.Rds") %>% 
  st_transform(crs = 2056)

stopifnot(
  length(unique(st_gg21$GMDNR)) == length(unique(gg21$GMDNR))
)
```

This is aggregated to the level of `r scales::number(length(unique(st_gg21$GMDNR)), big.mark = ",")` communities from swisstopo.

## STATPOP

```{r include=FALSE}
r18_bu_orig <- read_dta("../SNC_core/data-raw/statpop/r18_bu_orig.dta") %>% 
  zap_label() %>% zap_formats()

r18_bu <- r18_bu_orig %>% 
  filter(between(r18_gklas, 1110, 1122)) %>% 
  filter(!is.na(r18_gklas)) %>% 
  select(r18_egid, r18_comm, r18_gdename,
         r18_ecoord, r18_ncoord,
         r18_nrpers_main) %>% 
  # select(r18_nrpers_total, r18_nrpers_perm) %>% 
  # filter(!is.na(r18_ncoord)) %>% 
  # filter(!is.na(r18_ecoord)) %>% 
  st_as_sf(coords = c("r18_ecoord", "r18_ncoord"), 
           crs = 2056,
           remove = TRUE)
```

Using data from `STATPOP` **2018**. 

Used dataset consists of `r scales::number(nrow(r18_bu), big.mark = ",")` buildings. Excluding `r scales::number(nrow(filter(r18_bu_orig, !between(r18_gklas, 1110, 1122))), big.mark = ",")` nonresidential buildings and `r scales::number(nrow(filter(r18_bu_orig, is.na(r18_gklas))), big.mark = ",")` buildings missing information on classifications.   

The nearest building with SSEP was found; point dataset was then overlaid with community boundaries and summary measures of population based index were created and population level SEP was aggregated by community. `r18_nrpers_main` was used for population.^[Slightly different populations would be obtained with different conceptual models of *residential populations* by using either `r18_nrpers_total` or `r18_nrpers_perm` variables!]  

```{r include=FALSE}
rm(r18_bu_orig)
gc()
```

## 'nhood based averages

```{r include=FALSE}
ssep3_gem_21 <- 
  st_join(sep3, st_gg21, join = st_intersects) 

# tm_shape(gg21) +
#   tm_polygons() +
#   tm_shape(ssep3_gem_21 %>% filter(is.na(GMDNR))) +
#   tm_dots()

ssep3_gem_21_neigh <- ssep3_gem_21 %>% 
  st_drop_geometry() %>% 
  group_by(GMDNR) %>% 
  summarise(n = n(),
            # ssep3_mean = mean(ssep3),
            ssep3_median = median(ssep3)) %>% 
  ungroup() 

rm(ssep3_gem_21); gc()

breaks1 <- sep3 %>% 
  st_drop_geometry() %>% 
  group_by(ssep3_d) %>% 
  summarize(min = min(ssep3),
            max = max(ssep3))

ssep3_gem_21_neigh_geo <- inner_join(gg21, ssep3_gem_21_neigh) %>% 
  filter(!is.na(ssep3_median)) %>% 
  mutate(median_ssep3_samp_d = ntile(ssep3_median, 10)) %>% 
  mutate(median_ssep3_samp_d = factor(median_ssep3_samp_d,
                                      levels = 1:10,
                                      labels = c("1st - lowest", 
                                                 "2", "3", "4", 
                                                 "5th decile", 
                                                 "6", "7", "8", "9", 
                                                 "10th - highest")))

ssep3_gem_21_neigh_geo$median_ssep3_full_d <- cut(ssep3_gem_21_neigh_geo$ssep3_median, 
                                                  breaks = c(breaks1$min, 100),
                                                  include.lowest = TRUE,
                                                  labels = c("1st - lowest", 
                                                             "2", "3", "4", 
                                                             "5th decile", 
                                                             "6", "7", "8", "9", 
                                                             "10th - highest"))

rm(ssep3_gem_21_neigh); gc()

# write_rds(ssep3_gem_21_neigh_geo, "data/sep/ssep3_gem_21_neigh_geo.rds")
```

Watch out for small n! Here some examples with communities below 20 n'hoods

```{r}
ssep3_gem_21_neigh_geo %>% 
  st_drop_geometry() %>% 
  select(GMDNR, n) %>% 
  inner_join(st_drop_geometry(st_gg21)) %>% 
  filter(n < 19) %>% 
  arrange(n)

ssep3_gem_21_neigh_geo %>% 
  filter(n < 19) %>% 
  qtm(borders = "red", fill = "red")
```

### Final map using median index

Bubbles scaled to number of 'nhoods.

```{r, layout="l-body-outset"}
ssep3_gem_21_neigh_geo %>% 
  tm_shape() +
  tm_dots(size = "n", col = "ssep3_median", palette = "RdYlGn",
          scale = .5,  shape = 19)
```

### Deciles using sample of PLZs vs 'original' deciles

```{r}
frq(ssep3_gem_21_neigh_geo$median_ssep3_samp_d)
frq(ssep3_gem_21_neigh_geo$median_ssep3_full_d)
```

```{r, layout="l-page"}
ssep3_gem_21_neigh_geo %>% 
  tm_shape() +
  tm_fill(col = c("median_ssep3_samp_d", "median_ssep3_full_d"), 
          border.col = "white",
          palette = "RdYlGn")
```

## Population based

```{r eval=FALSE, include=FALSE}
# join to sep3
r18_bu_sep <- st_join(r18_bu, sep3, join = st_nearest_feature)

nearest <- st_nearest_feature(r18_bu, sep3)
r18_bu_sep$dist3 <- st_distance(r18_bu_sep, sep3[nearest, ], by_element = TRUE)
rm(nearest, r18_bu); gc()

summary(r18_bu_sep$dist3)

r18_bu_sep_gem21 <- 
  st_join(r18_bu_sep, st_gg21, join = st_intersects)

# r18_bu_sep_gem21 %>%
#   filter(is.na(GMDNR))
# 
# tm_shape(gg21) +
#   tm_polygons() +
#   tm_shape(r18_bu_sep_gem21 %>% filter(is.na(GMDNR)) %>% select(-r18_gdename)) +
#   tm_dots()

r18_bu_sep_gem21 <- r18_bu_sep_gem21 %>% 
  st_drop_geometry() %>% 
  relocate(GMDNR, .after = r18_egid) %>% 
  # covering 6 points outside of the map > lakes issues
  mutate(GMDNR = ifelse(r18_egid == 899324592, 4806, GMDNR)) %>% 
  mutate(GMDNR = ifelse(r18_egid == 899324589, 4806, GMDNR)) %>% 
  mutate(GMDNR = ifelse(r18_egid == 899324588, 4806, GMDNR)) %>% 
  mutate(GMDNR = ifelse(r18_egid == 898609635,  756, GMDNR)) %>% 
  mutate(GMDNR = ifelse(r18_egid == 898533015, 6417, GMDNR)) %>% 
  mutate(GMDNR = ifelse(r18_egid == 898563492,  942, GMDNR))  

# View(r18_bu_sep_gem21)

write_rds(r18_bu_sep_gem21, "data/sep/r18_bu_sep_gem21.rds")
```

```{r}
r18_bu_sep_gem21 <- read_rds("data/sep/r18_bu_sep_gem21.rds") 
```

```{r}
ssep3_gem_21_pop <- r18_bu_sep_gem21 %>% 
  select(GMDNR, ssep3, r18_nrpers_main) %>% 
  uncount(r18_nrpers_main) %>% 
  group_by(GMDNR) %>% 
  summarise(pop = n(),
            # ssep3_mean = mean(ssep3),
            ssep3_median = median(ssep3)) %>% 
  ungroup() 

ssep3_gem_21_pop_geo <- left_join(gg21, ssep3_gem_21_pop) %>% 
  filter(!is.na(ssep3_median)) %>% 
  mutate(median_ssep3_samp_d = ntile(ssep3_median, 10)) %>% 
  mutate(median_ssep3_samp_d = factor(median_ssep3_samp_d,
                                      levels = 1:10,
                                      labels = c("1st - lowest", 
                                                 "2", "3", "4", 
                                                 "5th decile", 
                                                 "6", "7", "8", "9", 
                                                 "10th - highest")))

ssep3_gem_21_pop_geo$median_ssep3_full_d <- cut(ssep3_gem_21_pop_geo$ssep3_median, 
                                                breaks = c(breaks1$min, 100),
                                                include.lowest = TRUE,
                                                labels = c("1st - lowest", 
                                                           "2", "3", "4", 
                                                           "5th decile", 
                                                           "6", "7", "8", "9", 
                                                           "10th - highest"))

# write_rds(ssep3_gem_21_pop_geo, "data/sep/ssep3_gem_21_pop_geo.rds")
```

### Final map using median index

Bubbles scaled to number of people (2018)

```{r, layout="l-body-outset"}
ssep3_gem_21_pop_geo %>% 
  tm_shape() +
  tm_dots(size = "pop", col = "ssep3_median", palette = "RdYlGn",
          scale = .5,  shape = 19)
```

### Deciles using sample of communities vs 'original' deciles

```{r}
frq(ssep3_gem_21_pop_geo$median_ssep3_samp_d)
frq(ssep3_gem_21_pop_geo$median_ssep3_full_d)
```

```{r, layout="l-page"}
ssep3_gem_21_pop_geo %>% 
  tm_shape() +
  tm_fill(col = c("median_ssep3_samp_d", "median_ssep3_full_d"), 
          palette = "RdYlGn")
```

## Maps 
### All CH gem

```{r}
logo <- magick::image_read("carto/snc.png")
magick::image_info(logo)

st_bbox(canton)$xmax
st_bbox(lake)
```

```{r}
ggplot() + 
  geom_sf(data = lake, color = NA,  fill = rgb(176, 229, 255, max = 255)) + 
  geom_sf(data = ssep3_gem_21_pop_geo,
          aes(fill = median_ssep3_samp_d),
          color = "white", size = 0.2, alpha = 0.85) +
  geom_sf(data = canton, fill = NA, color = gray(.5), size = 0.5) +
  scale_fill_brewer(palette = "RdYlGn") +
  theme_void() + 
  theme(legend.position = c(.05, .95), 
        legend.justification = c("left", "top"),
        legend.direction = 'vertical') +
  guides(colour = guide_legend(title = "Swiss-SEP",
                               override.aes = list(alpha = 1, shape = 16, size = 3))) +
  labs(fill = "Index decile") +
  annotation_custom(grid::rasterGrob(logo), 
                    xmin = st_bbox(canton)$xmax - 23400*2, 
                    xmax = st_bbox(canton)$xmax, 
                    ymin = st_bbox(lake)$ymin, 
                    ymax = st_bbox(lake)$ymin + 11000*2) 

ggsave("docs/sep-gem21.png", width = 297, height = 210, 
       units = "mm", dpi = 300)
```

### All CH point

```{r}
# for experiments
sep3_samp <- sep3 %>% 
  sample_frac(0.01)

# display.brewer.pal(n = 10, name = "RdYlGn") 

# # sf plotting
plot(st_geometry(canton),
     col = NA, border = "gray50", lwd = 0.1,
     reset = FALSE)
plot(st_geometry(lake),
     # col = rgb(0, 135, 208, max = 255), border = NA,
     # col = rgb(156, 213, 248, max = 255), border = NA,
     col = rgb(176, 229, 255, max = 255), border = NA,
     add = TRUE)
plot(ssep3_samp["ssep3_d"],
     pal = RColorBrewer::brewer.pal(n = 10, name = "RdYlGn"),
     cex = 0.1, pch = 16,
     add = TRUE)
```


```{r}
ggplot() + 
  geom_sf(data = lake, color = NA, fill = rgb(176, 229, 255, max = 255)) + 
  geom_sf(data = canton, fill = NA, color = gray(.5), size = 0.25) +
  # geom_sf(data = sep3_samp, aes(colour = ssep3_d), 
  #         alpha = 0.66, shape = ".", size = 0.1) +
  geom_sf(data = sep3, aes(colour = ssep3_d),
          alpha = 0.66, shape = ".", size = 0.1) +
  scale_colour_brewer(palette = "RdYlGn") +
  theme_void() + 
  theme(legend.position = c(.05, .95), 
        legend.justification = c("left", "top"),
        legend.direction = 'vertical') +
  guides(colour = guide_legend(title = "Swiss-SEP",
                               override.aes = list(alpha = 1, shape = 16, size = 3))) +
  annotation_custom(grid::rasterGrob(logo), 
                    xmin = st_bbox(canton)$xmax - 23400*2, 
                    xmax = st_bbox(canton)$xmax, 
                    ymin = st_bbox(lake)$ymin, 
                    ymax = st_bbox(lake)$ymin + 11000*2) 

ggsave("docs/sep-dots.png", width = 297, height = 210, 
       units = "mm", dpi = 300)
```

```{r}
ssep3_gem_21_pop_geo %>% 
  select(GMDNR, GMDNAME, ssep3_median, median_ssep3_samp_d) %>% 
  st_write("docs/ssep3_gem_21_pop_geo.shp", delete_dsn = TRUE)

ssep3_gem_21_pop_geo %>% 
  st_drop_geometry() %>% 
  select(GMDNR, GMDNAME, ssep3_median, median_ssep3_samp_d) %>% 
  write_csv("docs/ssep3_gem_21_pop_geo.csv")
```


<!-- ----------------------------------------------------- -->

# Raumgliederungen 

From the [app](https://www.agvchapp.bfs.admin.ch/de/typologies/query). State as of `2021-07-01` to match spatial data nicely.  

```{r}
raum <- read_xlsx("data-raw/BfS/Raumgliederungen.xlsx", 
                  skip = 1) %>% 
  remove_empty(c("rows", "cols")) %>% clean_names() %>% 
  filter(! is.na(bfs_gde_nummer)) %>% 
  rename(GMDNR = bfs_gde_nummer,
         GMDNAME = gemeindename,
         KTNAME = kanton,
         BZNR = bezirks_nummer,
         BZNAME = bezirksname) %>% 
  select(GMDNR, GMDNAME, KTNAME, BZNR, BZNAME, 
         stadtische_landliche_gebiete, sprachgebiete,
         urbanisierungsgrad_2011_degurba_eurostat) %>% 
  mutate(
    r_urban1 = case_when(
      stadtische_landliche_gebiete == 1 ~  "Urban",
      stadtische_landliche_gebiete == 2 ~  "Periurban",
      stadtische_landliche_gebiete == 3 ~  "Rural",
      TRUE ~  ""),
    r_urban2 = case_when(
      urbanisierungsgrad_2011_degurba_eurostat == 1 ~  "Dense",
      urbanisierungsgrad_2011_degurba_eurostat == 2 ~  "Medium",
      urbanisierungsgrad_2011_degurba_eurostat == 3 ~  "Low",
      TRUE ~  ""),
    r_lang = case_when(
      sprachgebiete == 1 ~  "German",
      sprachgebiete == 2 ~  "French",
      sprachgebiete == 3 ~  "Italian",
      sprachgebiete == 4 ~  "Romansh",
      TRUE ~  "")
  ) %>% 
  select(-stadtische_landliche_gebiete, -sprachgebiete,
         -urbanisierungsgrad_2011_degurba_eurostat)
```

```{r include=FALSE}
stopifnot(nrow(anti_join(raum, gg21)) == 0)

gg21_merged <- gg21 %>% 
  left_join(raum) %>% 
  relocate(KTNAME, .after = KTNR)
```

## Urbanization 1 

```{r echo=FALSE}
frq(raum, r_urban1)

tm_shape(se21, is.master = FALSE) +
  tm_fill(col = "#a7cdf2")  +
  tm_shape(gg21_merged) +
  tm_fill(col = "r_urban1")  +
  tm_shape(kt21) +
  tm_borders()  +
  tm_layout(
    title = "Urbanization 2021"
  )
```

## Urbanization 2 

Using [DEGURBA](https://ec.europa.eu/eurostat/web/degree-of-urbanisation/background).  
```{r echo=FALSE}
frq(raum, r_urban2)

tm_shape(se21, is.master = FALSE) +
  tm_fill(col = "#a7cdf2")  +
  tm_shape(gg21_merged) +
  tm_fill(col = "r_urban2")  +
  tm_shape(kt21) +
  tm_borders()  +
  tm_layout(
    title = "Urbanization 2021"
  )
```

## Language region

```{r echo=FALSE}
frq(raum, r_lang)

tm_shape(se21, is.master = FALSE) +
  tm_fill(col = "#a7cdf2")  +
  tm_shape(gg21_merged) +
  tm_fill(col = "r_lang")  +
  tm_shape(kt21) +
  tm_borders()  +
  tm_layout(
    title = "Language region 2021"
  )
```

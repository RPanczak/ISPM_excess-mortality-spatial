---
title: "Spatial analyses of 2020-21 excess mortality in CH"
subtitle: "Ancillary data preparation"
pagetitle: "Spatial Excess: more data"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(haven, readxl,
       tidyverse, magrittr, janitor, scales, lubridate, 
       DT, 
       sf, tmap,
       swissdd)

import::from("sjmisc", "frq")
```

```{r conflicts, include = FALSE}
tidyverse::tidyverse_conflicts()

conflicted::conflict_scout()
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)
```

<!-- ----------------------------------------------------- -->

# Raumgliederungen 

Data from the [app](https://www.agvchapp.bfs.admin.ch/de/typologies/query). State as of `2021-07-01` to match spatial data nicely.  

```{r}
raum <- read_xlsx("data-raw/BfS/Raumgliederungen.xlsx", 
                  skip = 1) %>% 
  remove_empty(c("rows", "cols")) %>% clean_names() %>% 
  filter(! is.na(bfs_gde_nummer)) %>% 
  rename(GMDNR = bfs_gde_nummer,
         GMDNAME = gemeindename,
         KTNAME = kanton,
         BZNR = bezirks_nummer,
         BZNAME = bezirksname) %>% 
  select(GMDNR, GMDNAME, KTNAME, BZNR, BZNAME, 
         stadtische_landliche_gebiete, sprachgebiete,
         urbanisierungsgrad_2011_degurba_eurostat) %>% 
  mutate(
    r_urban1 = case_when(
      stadtische_landliche_gebiete == 1 ~  "Urban",
      stadtische_landliche_gebiete == 2 ~  "Periurban",
      stadtische_landliche_gebiete == 3 ~  "Rural",
      TRUE ~  ""),
    r_urban2 = case_when(
      urbanisierungsgrad_2011_degurba_eurostat == 1 ~  "Dense",
      urbanisierungsgrad_2011_degurba_eurostat == 2 ~  "Medium",
      urbanisierungsgrad_2011_degurba_eurostat == 3 ~  "Low",
      TRUE ~  ""),
    r_lang = case_when(
      sprachgebiete == 1 ~  "German",
      sprachgebiete == 2 ~  "French",
      sprachgebiete == 3 ~  "Italian",
      sprachgebiete == 4 ~  "Romansh",
      TRUE ~  "")
  ) %>% 
  select(-stadtische_landliche_gebiete, -sprachgebiete,
         -urbanisierungsgrad_2011_degurba_eurostat)
```

```{r include=FALSE}
stopifnot(nrow(anti_join(raum, gg21)) == 0)

gg21_merged <- gg21 %>% 
  left_join(raum) %>% 
  relocate(geometry, .after = last_col())

tmap_mode("plot")
```

## Urbanization 1 

```{r echo=FALSE}
frq(raum, r_urban1)

tm_shape(se21, is.master = FALSE) +
  tm_fill(col = "#a7cdf2")  +
  tm_shape(gg21_merged) +
  tm_fill(col = "r_urban1")  +
  tm_shape(kt21) +
  tm_borders()  +
  tm_layout(
    title = "Urbanization 2021"
  )
```

## Urbanization 2 

Using [DEGURBA](https://ec.europa.eu/eurostat/web/degree-of-urbanisation/background).  

```{r echo=FALSE}
frq(raum, r_urban2)

tm_shape(se21, is.master = FALSE) +
  tm_fill(col = "#a7cdf2")  +
  tm_shape(gg21_merged) +
  tm_fill(col = "r_urban2", palette = "-Set3")  +
  tm_shape(kt21) +
  tm_borders()  +
  tm_layout(
    title = "Urbanization 2021"
  )
```

## Language region

```{r echo=FALSE}
frq(raum, r_lang)

tm_shape(se21, is.master = FALSE) +
  tm_fill(col = "#a7cdf2")  +
  tm_shape(gg21_merged) +
  tm_fill(col = "r_lang")  +
  tm_shape(kt21) +
  tm_borders()  +
  tm_layout(
    title = "Language region 2021"
  )
```

```{r include=FALSE}
# final link
w_deaths_2015_2021_pop %<>% 
  left_join(ssep3_gem_21_pop_geo %>% 
              st_drop_geometry() %>% 
              select(-pop)) %>% 
  left_join(gg21_merged %>% 
              st_drop_geometry() %>% 
              select(-GMDNAME, -KTNAME, -BZNR, -BZNAME)
  )

write_rds(w_deaths_2015_2021_pop, "data/BfS-closed/monthly_deaths/w_deaths_2015_2021_pop.Rds")

w_deaths_2015_2021_ar_pop %>% 
  left_join(
    read_rds("data/BfS/raum.Rds") %>% 
      select(ARNR, border)
  ) %>% 
  left_join(ssep3_ar_21_pop_geo %>% 
              st_drop_geometry() %>% 
              select(-pop)
  )

write_rds(w_deaths_2015_2021_ar_pop, "data/BfS/w_deaths_2015_2021_ar_pop.Rds")
```

```{r eval=FALSE, include=FALSE}
# unlink("data/BfS-closed/w_deaths_2015_2021_exp.Rds")
# unlink("data/BfS-closed/w_deaths_2015_2021_ar.Rds")
```

<!-- ----------------------------------------------------- -->

# Voting

Data from `swissdd` [package](https://github.com/politanch/swissdd).    

Linked to municipality boundaries from `2022-01-01`.  

```{r}
st_gg22 <- read_rds("data/swisstopo/st_gg22.Rds")
```

## June vote

> Bundesgesetz vom 25.09.2020 über die gesetzlichen Grundlagen für Verordnungen des Bundesrates zur Bewältigung der Covid-19-Epidemie (Covid-19-Gesetz)

### Data 

```{r}
covid_jun <- get_nationalvotes(votedates = "2021-06-13", 
                               geolevel = "municipality") %>% 
  filter(name == "Bundesgesetz über die gesetzlichen Grundlagen für Verordnungen des Bundesrates zur Bewältigung der Covid-19-Epidemie (Covid-19-Gesetz)") %>% 
  select(-name, -id)
```

```{r echo=FALSE, include=FALSE}
# Votes from abroad are excluded. 
# covid_jun %>% 
#   filter(str_detect(mun_name, fixed("Ausland")) | str_detect(mun_name, fixed("l'étranger"))) %>% 
#   select(mun_name, jaStimmenAbsolut, jaStimmenInProzent)

covid_jun %<>% 
  filter(! str_detect(mun_name, fixed("Ausland"))) %>% 
  filter(! str_detect(mun_name, fixed("l'étranger"))) %>% 
  mutate(GMDNR = as.numeric(mun_id)) %>% 
  relocate(GMDNR)
```

Dataset consists of `r scales::number(length(unique(covid_jun$mun_id)), big.mark = ",")` communities.

### Results preview

```{r echo=FALSE}
plot_nationalvotes(votedate = "2021-06-13", 
                   vote_id = 6430, geolevel = "municipality")
```

### Link to municipalities

Using `GMDNR` / `mun_id` for deterministic linkage.  

```{r}
covid_jun_gem <- st_gg22 %>%  
  left_join(covid_jun)
```

There are few communities that exist on the map but do not exist in the voting dataset:   

```{r echo=FALSE}
covid_jun_gem %>% 
  st_drop_geometry() %>% 
  filter(is.na(jaStimmenInProzent)) %>% 
  select(GMDNR, GMDNAME)
```

```{r include=FALSE}
write_rds(covid_jun, "data/voting/covid_jun.Rds")
write_rds(covid_jun_gem, "data/voting/covid_jun_gem.Rds")
```

## November vote

> Änderung des Bundesgesetzes über die gesetzlichen Grundlagen für Verordnungen des Bundesrates zur Bewältigung der Covid-19-Epidemie (Covid-19-Gesetz) (Härtefälle, Arbeitslosenversicherung, familienergänzende Kinderbetreuung, Kulturschaffende, Veranstaltungen)  

### Data 

```{r}
covid_nov <- get_nationalvotes(votedates = "2021-11-28", 
                               geolevel = "municipality") %>% 
  filter(name == "Änderung des Bundesgesetzes über die gesetzlichen Grundlagen für Verordnungen des Bundesrates zur Bewältigung der Covid-19-Epidemie (Covid-19-Gesetz) (Härtefälle, Arbeitslosenversicherung, familienergänzende Kinderbetreuung, Kulturschaffende, Veranstaltungen)") %>% 
  select(-name, -id)
```

```{r echo=FALSE, include=FALSE}
# Votes from abroad are excluded. 
# covid_nov %>% 
#   filter(str_detect(mun_name, fixed("Ausland")) | str_detect(mun_name, fixed("l'étranger"))) %>% 
#   select(mun_name, jaStimmenAbsolut, jaStimmenInProzent)

covid_nov %<>% 
  filter(! str_detect(mun_name, fixed("Ausland"))) %>% 
  filter(! str_detect(mun_name, fixed("l'étranger"))) %>% 
  mutate(GMDNR = as.numeric(mun_id)) %>% 
  relocate(GMDNR)
```

Dataset consists of `r scales::number(length(unique(covid_nov$mun_id)), big.mark = ",")` communities.

### Results preview

```{r echo=FALSE}
plot_nationalvotes(votedate = "2021-11-28", 
                   vote_id = 6500, geolevel = "municipality")
```

### Link to municipalities

Using `GMDNR` / `mun_id` for deterministic linkage.  

```{r}
covid_nov_gem <- st_gg22 %>%  
  left_join(covid_nov)
```

There are again few communities that exist on the map but do not exist in the voting dataset:  

```{r echo=FALSE}
covid_nov_gem %>% 
  st_drop_geometry() %>% 
  filter(is.na(jaStimmenInProzent)) %>% 
  select(GMDNR, GMDNAME)
```

```{r include=FALSE}
write_rds(covid_nov, "data/voting/covid_nov.Rds")
write_rds(covid_nov_gem, "data/voting/covid_nov_gem.Rds")
```
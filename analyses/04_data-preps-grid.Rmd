---
title: "Spatial analyses of 2020-21 excess mortality in CH"
subtitle: "Grid & grided data preparation"
author: "Radek Panczak & Garyfallos Konstantinoudis"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, magrittr, scales,  
       DT, 
       sf, tmap)

tmap_mode("view")

import::from("sjmisc", "frq")
```

```{r conflicts, include = FALSE}
tidyverse::tidyverse_conflicts()

conflicted::conflict_scout()
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Geo 

```{r}
gg21 <- read_rds("data/BfS/gg21.Rds")

st_gg21 <- read_rds("data/swisstopo/st_gg21.Rds")
```

<!-- ----------------------------------------------------- -->

# STATPOP

Used to define `offset` for `st_make_grid`

```{r}
statpop_20 <- read_delim("data-raw/BfS/ag-b-00.03-vz2020statpop/STATPOP2020.zip", 
                         delim = ";", escape_double = FALSE, trim_ws = TRUE)[] %>% 
  mutate_all(as.integer)

offset <- statpop_20 %>% 
  summarise(minX = min(E_KOORD),
            minY = min(N_KOORD))

# statpop_20 %>% slice(1:10) %>% View()
```

<!-- ----------------------------------------------------- -->

# Grid

## swisstopo coverage

1-km grid, with lower left corner defined using `STATPOP` cells and **clipped using swisstopo municipality data**.  

Also, adding ID for each cell (based on row number) and area.  

```{r}
st_grid_1km <- st_gg21 %>% 
  st_make_grid(cellsize = 1000, square = TRUE, 
               offset = c(offset$minX, offset$minY)) %>% 
  st_sf() %>%
  st_cast("POLYGON") %>% 
  mutate(ID1 = row_number()) %>% 
  relocate(ID1)

st_grid_1km_crop <- st_grid_1km %>% 
  st_intersection(st_gg21)  %>%
  mutate(ID2 = row_number(),
         area = st_area(.)) %>% 
  relocate(ID1, ID2, area)
```

```{r include=FALSE}
# st_write(st_grid_1km, "data/grid/st_grid_1km.gpkg")
st_write(st_grid_1km_crop, "data/grid/grid_1km.gpkg", 
         layer = "st_grid_1km_crop", delete_dsn = TRUE)

# write_rds(st_grid_1km, "data/grid/st_grid_1km.Rds")
write_rds(st_grid_1km_crop, "data/grid/st_grid_1km_crop.Rds")
```

Example of municipality Bern coverage:  

```{r}
st_join(st_grid_1km_crop,
        st_gg21 %>% filter(GMDNR == 351),
        left = FALSE) %>% 
  st_geometry() %>% 
  plot()
```

There are few examples of grid cells with very small area. These could be excluded if no population was found there?

```{r}
st_grid_1km_crop %>% 
  st_join(st_grid_1km_crop %>% 
            arrange(area) %>% 
            slice(2),
          join = st_touches, left = FALSE) %>% 
  st_geometry() %>% 
  qtm()
```

## BfS coverage

1-km grid, with lower left corner defined using `STATPOP` cells and this time **clipped using BfS municipality data**.  

Also, adding ID for each cell (based on row number) and area.  

```{r}
grid_1km <- gg21 %>% 
  st_make_grid(cellsize = 1000, square = TRUE, 
               offset = c(offset$minX, offset$minY)) %>% 
  st_sf() %>%
  st_cast("POLYGON") %>% 
  mutate(ID1 = row_number()) %>% 
  relocate(ID1)

grid_1km_crop <- grid_1km %>% 
  st_intersection(gg21)  %>%
  mutate(ID2 = row_number(),
         area = st_area(.)) %>% 
  relocate(ID1, ID2, area)
```

```{r include=FALSE}
# st_write(grid_1km, "data/grid/grid_1km.gpkg")
st_write(grid_1km_crop, "data/grid/grid_1km.gpkg", 
         layer = "grid_1km_crop", append = TRUE)

# write_rds(grid_1km, "data/grid/grid_1km.Rds")
write_rds(grid_1km_crop, "data/grid/grid_1km_crop.Rds",)
```

Example of 

```{r}
grid_1km_crop %>% 
  st_join(grid_1km_crop %>% 
            arrange(area) %>% 
            slice(2),
          join = st_touches, left = FALSE) %>% 
  st_geometry() %>% 
  qtm()
```
---
title: "Spatial analyses of 2020-21 excess mortality in CH"
subtitle: "Grid & grided data preparation"
pagetitle: "Spatial Excess: grid"
author: "Radek Panczak & Garyfallos Konstantinoudis"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, lubridate, magrittr, scales, haven,  
       DT, 
       sf, tmap)

tmap_mode("view")

import::from("sjmisc", "frq")
```

```{r conflicts, include = FALSE}
tidyverse::tidyverse_conflicts()

conflicted::conflict_scout()
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Grid

## Municipality boundaries

Used to 'clip' the data to the country outline, 'remove' the area of lakes and introduce the boundaries within grid cells belonging to two different municipalities.   

```{r}
st_gg21 <- read_rds("data/swisstopo/st_gg21.Rds") %>% 
  st_transform(2056)

st_se21_sel <- read_rds("data/swisstopo/st_se21_sel.Rds") %>% 
  st_transform(2056)
```

## Offset

<!-- Openly available STATPOP dataset is used to define `offset` (ie. starting point; lowest left corner) for `st_make_grid`.   -->

```{r eval=FALSE, include=FALSE}
origin_statpop <- read_delim("data-raw/BfS/ag-b-00.03-vz2020statpop/STATPOP2020.zip", 
                             delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  mutate_all(as.integer) %>% 
  summarise(minX = min(E_KOORD),
            minY = min(N_KOORD)) %>% 
  st_as_sf(coords = c("minX", "minY"), 
           crs = 2056,
           remove = FALSE)

qtm(origin_statpop)
```

```{r eval=FALSE, include=FALSE}
offset_statpop <- read_delim("data-raw/BfS/ag-b-00.03-vz2020statpop/STATPOP2020.zip", 
                             delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  mutate_all(as.integer) %>% 
  summarise(minX = min(E_KOORD),
            minY = min(N_KOORD))
```

One of the meteoswiss datasets is used to define `offset` (ie. starting point; lowest left corner) for `st_make_grid`.  

Using meteoswiss origin will allow us to perfectly align gridded mortality and population data to meteo data.   

```{r}
p_load(ncdf4)

TabsD_14 <- nc_open('data-raw/meteoswiss/TabsD_ch01r.swiss.lv95_201401010000_201412310000.nc')

E <- ncvar_get(TabsD_14, "E") # X, lon
N <- ncvar_get(TabsD_14, "N") # Y, lat

offset_meteoswiss <- as_tibble(cbind(minX = as.integer(min(E)), 
                                     minY = as.integer(min(N))))

p_unload(ncdf4)
```

```{r eval=FALSE, include=FALSE}
# offset_statpop
offset_meteoswiss

origin_meteoswiss <- st_as_sf(tibble(E = min(E), N = min(N)), 
                              coords = c("E", "N")) %>%
  st_set_crs(2056) 

qtm(origin)
```

## Grid 

1-km grid, with lower left corner defined using `STATPOP` cells.

Grid is then overlaid with *swisstopo municipality data* to select only cells that overlay it.  

At next step the areas of lakes are 'clipped' from the grid.  

Lastly, **experimental** grid integrating municipality boundaries is also created.

Also, adding ID for each cell (based on row number) and area for each of the iterations.  

```{r eval=FALSE}
grid_1km <- st_gg21 %>% 
  st_make_grid(cellsize = 1000, square = TRUE, 
               offset = c(offset_meteoswiss$minX, offset_meteoswiss$minY)) %>% 
  st_sf() %>%
  st_cast("POLYGON") %>% 
  st_filter(st_gg21, join = st_covers)  %>%
  mutate(ID = row_number()) %>% 
  relocate(ID) %>% 
  st_transform(2056)

# this one takes some time
grid_1km_crop <- grid_1km %>% 
  st_intersection(st_union(st_gg21)) %>% 
  st_collection_extract("POLYGON") %>% 
  mutate(area = st_area(.)) %>% 
  relocate(ID, area) %>%   
  st_transform(2056)

grid_1km_over <- grid_1km_crop %>%
  st_intersection(st_gg21)  %>%
  mutate(ID2 = row_number(),
         area2 = st_area(.)) %>%
  relocate(ID, ID2, area, area2) %>% 
  st_transform(2056)
```

```{r eval=FALSE, include=FALSE}
View(st_drop_geometry(grid_1km))
plot(st_geometry(grid_1km))

View(st_drop_geometry(grid_1km_crop))
plot(st_geometry(grid_1km_crop))

View(st_drop_geometry(grid_1km_over))
plot(st_geometry(grid_1km_over))
```

```{r eval=FALSE, include=FALSE}
# grids
st_write(grid_1km, "data/grid/grid_1km.gpkg", 
         layer = "grid_1km", delete_dsn = TRUE)
st_write(grid_1km_crop, "data/grid/grid_1km.gpkg",
         layer = "grid_1km_crop", append = TRUE)
st_write(grid_1km_over, "data/grid/grid_1km.gpkg", 
         layer = "grid_1km_over", append = TRUE)

# admin bound
st_write(st_gg21, "data/grid/grid_1km.gpkg", 
         layer = "st_gg21", append = TRUE)
st_write(st_se21_sel, "data/grid/grid_1km.gpkg", 
         layer = "st_se21_sel", append = TRUE)

write_rds(grid_1km, "data/grid/grid_1km.Rds")
write_rds(grid_1km_crop, "data/grid/grid_1km_crop.Rds")
write_rds(grid_1km_over, "data/grid/grid_1km_over.Rds")
```

```{r include=FALSE}
grid_1km <- read_rds("data/grid/grid_1km.Rds")
grid_1km_crop <- read_rds("data/grid/grid_1km_crop.Rds")
grid_1km_over <- read_rds("data/grid/grid_1km_over.Rds")
```

Example of Bern  

```{r echo=FALSE}
tm_shape(st_gg21 %>% filter(GMDNR == 351)) + 
  tm_borders(col = "darkorchid") +
  tm_shape(st_join(grid_1km,
                   st_gg21 %>% filter(GMDNR == 351),
                   left = FALSE)) + 
  tm_borders(col = "red")
```

## Grid comparison

Example of different integration of boundaries of `Gottlieben` municipality.  

Comparing grid of 'regular' cells (green) and cells 'cropped' by outlines of the country and water bodies. Only grid cells that overlay area of municipality are shown (purple):  

```{r echo=FALSE}
tm_shape(st_gg21 %>% filter(GMDNR == 4651)) + 
  tm_borders(col = "darkorchid") +
  tm_shape(st_join(grid_1km,
                   st_gg21 %>% filter(GMDNR == 4651),
                   left = FALSE)) + 
  tm_borders(col = "forestgreen") +
  tm_shape(st_join(grid_1km_crop,
                   st_gg21 %>% filter(GMDNR == 4651),
                   left = FALSE)) + 
  tm_borders(col = "red")
```

Comparing grid of 'cropped' cells (red again) with grid integrating community boundaries (yellow). Note subdivision of regular cells into smaller ([sometimes very small!](https://github.com/RPanczak/ISPM_geo-mortality/issues/49)) units:   

```{r echo=FALSE}
tm_shape(st_join(grid_1km_crop,
                 st_gg21 %>% filter(GMDNR == 4651),
                 left = FALSE)) + 
  tm_borders(col = "red") +
  tm_shape(st_join(grid_1km_over,
                   st_gg21 %>% filter(GMDNR == 4651),
                   left = FALSE)) + 
  tm_borders(col = "yellow")
```

## Grid centroids

```{r}
grid_1km_cent <- st_centroid(grid_1km)

grid_1km_cent %<>% 
  mutate(X = st_coordinates(.)[, 1],
         Y = st_coordinates(.)[, 2]) %>% 
  relocate(geometry, .after = last_col())
```

```{r include=FALSE}
grid_1km_crop_cent <- st_centroid(grid_1km_crop)

grid_1km_crop_cent %<>% 
  mutate(X = st_coordinates(grid_1km_crop_cent)[, 1],
         Y = st_coordinates(grid_1km_crop_cent)[, 2]) %>% 
  relocate(geometry, .after = last_col())

st_write(grid_1km_cent, "data/grid/grid_1km.gpkg", 
         layer = "grid_1km_cent", append = TRUE)
st_write(grid_1km_crop_cent, "data/grid/grid_1km.gpkg", 
         layer = "grid_1km_crop_cent", append = TRUE)

write_rds(grid_1km_cent, "data/grid/grid_1km_cent.Rds")
write_rds(grid_1km_crop_cent, "data/grid/grid_1km_crop_cent.Rds")
```

```{r eval=FALSE, include=FALSE}
View(st_drop_geometry(grid_1km))
plot(st_geometry(grid_1km))
```

Example of Bern:    

```{r echo=FALSE}
tm_shape(st_gg21 %>% filter(GMDNR == 351)) + 
  tm_borders(col = "darkorchid") +
  tm_shape(st_join(grid_1km,
                   st_gg21 %>% filter(GMDNR == 351),
                   left = FALSE)) + 
  tm_borders(col = "red") +
  tm_shape(st_join(grid_1km_cent,
                   st_gg21 %>% filter(GMDNR == 351),
                   left = FALSE)) + 
  tm_dots() 
```

Of course different grids will result in slightly different centroids in areas that were modified:  

```{r echo=FALSE}
tm_shape(st_join(grid_1km,
                 st_gg21 %>% filter(GMDNR == 4651),
                 left = FALSE)) + 
  tm_borders(col = "red") +
  tm_shape(st_join(grid_1km_crop,
                   st_gg21 %>% filter(GMDNR == 4651),
                   left = FALSE)) + 
  tm_borders(col = "forestgreen") +
  tm_shape(st_join(grid_1km_cent,
                   st_join(grid_1km,
                           st_gg21 %>% filter(GMDNR == 4651),
                           left = FALSE),
                   left = FALSE)) + 
  tm_dots(col = "red") + 
  tm_shape(st_join(grid_1km_crop_cent,
                   st_join(grid_1km,
                           st_gg21 %>% filter(GMDNR == 4651),
                           left = FALSE),
                   left = FALSE)) + 
  tm_dots(col = "forestgreen") 
```

<!-- ----------------------------------------------------- -->

# Gridded data

## Test areas

```{r}
bern <- st_join(grid_1km,
                st_gg21 %>% filter(GMDNR == 351),
                left = FALSE)

scuol <- st_join(grid_1km,
                 st_gg21 %>% filter(GMDNR == 3762),
                 left = FALSE)
```

Using *Bern* (map above) with `r number(nrow(bern))` cells as example of densely populated urban area. And *Scuol* (largest municipality in CH) with `r number(nrow(scuol))` cells - good example of where we expect many zeroes?  

```{r echo=FALSE}
tm_shape(st_gg21 %>% filter(GMDNR == 3762)) + 
  tm_borders(col = "darkorchid") +
  tm_shape(scuol) + 
  tm_borders(col = "red")
```

```{r message=FALSE, include=FALSE}
area <- bind_rows(bern, scuol)

write_rds(area, "data/grid/area.Rds")
# write_rds(bern, "data/grid/bern.Rds")
# write_rds(scuol, "data/grid/scuol.Rds")

rm(bern, scuol); gc()
```


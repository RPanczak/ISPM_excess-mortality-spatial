---
title: "Spatial analyses of 2020-21 excess mortality in CH"
subtitle: "EDA"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(sf, tidyverse, magrittr, scales, DT, tmap)

import::from("sjmisc", "frq")
```

```{r conflicts, include = FALSE}
tidyverse::tidyverse_conflicts()

conflicted::conflict_scout()
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Zeroes

## AR level

```{r}
w_deaths_2015_2021_ar_pop <- read_rds("data/BfS-closed/monthly_deaths/w_deaths_2015_2021_ar_pop.Rds")
```

```{r eval=FALSE, include=FALSE}
sapply(w_deaths_2015_2021_ar_pop, function(x) sum(is.na(x)))
```

```{r echo=FALSE}
frq(w_deaths_2015_2021_ar_pop, deaths == 0)

ggplot(w_deaths_2015_2021_ar_pop) + 
  geom_histogram(aes(x = deaths), binwidth = 1) +
  theme_minimal()
```

## Municipality level 

```{r}
w_deaths_2015_2021_pop <- read_rds("data/BfS-closed/monthly_deaths/w_deaths_2015_2021_pop.Rds")
```

```{r eval=FALSE, include=FALSE}
sapply(w_deaths_2015_2021_pop, function(x) sum(is.na(x)))
```

```{r echo=FALSE}
frq(w_deaths_2015_2021_pop, deaths == 0)

ggplot(w_deaths_2015_2021_pop) + 
  geom_histogram(aes(x = deaths), binwidth = 1) +
  theme_minimal()
```

<!-- ----------------------------------------------------- -->

# Deaths > population

## AR level

```{r}
length(unique(w_deaths_2015_2021_ar_pop$ARNR))
```

```{r}
frq(w_deaths_2015_2021_ar_pop, deaths > population)
```

```{r}
w_deaths_2015_2021_ar_pop %>%
  group_by(year) %>%
  summarise(deaths = sum(deaths))
```

## Municipality level 

```{r}
length(unique(w_deaths_2015_2021_pop$GMDNR))
```

```{r eval=FALSE, include=FALSE}
frq(w_deaths_2015_2021_pop, deaths > population)
```

```{r eval=FALSE, include=FALSE}
w_deaths_2015_2021_pop %>% 
  filter(deaths > population) %>% 
  mutate(diff = deaths - population) %>% 
  select(diff) %>% 
  summary()
```

```{r eval=FALSE, include=FALSE}
w_deaths_2015_2021_pop %>% 
  mutate(diff = population - deaths) %>% 
  filter(deaths > population) %>% 
  select(GMDNAME, KTNAME, year, age, sex, diff, deaths, population) %>% 
  datatable()
```

```{r}
frq(w_deaths_2015_2021_pop, deaths > population_mid_poi)
```

```{r}
w_deaths_2015_2021_pop %>% 
  filter(deaths > population_mid_poi) %>% 
  mutate(diff = deaths - population_mid_poi) %>% 
  select(diff) %>% 
  summary()
```

```{r}
w_deaths_2015_2021_pop %>% 
  mutate(diff = population_mid_poi - deaths) %>% 
  filter(deaths > population_mid_poi) %>% 
  select(GMDNAME, KTNAME, year, age, sex, diff, deaths, population_mid_poi) %>% 
  datatable()
```

<!-- ----------------------------------------------------- -->

# Differences in pop estimates (municipality)

## Age group specific diffs

```{r}
frq(w_deaths_2015_2021_pop, population_mid_poi > population) 

pop_diff <- w_deaths_2015_2021_pop %>% 
  mutate(pop_diff = population_mid_lm - population,
         perc_diff = (pop_diff / population_mid_lm) * 100)

summary(pop_diff$pop_diff)
summary(pop_diff$perc_diff)
```

## Municipality specific diffs

```{r}
gg21 <- readRDS("data/BfS/gg21.Rds")

gg21_centr <- st_centroid(gg21)

pop_diff <- w_deaths_2015_2021_pop %>% 
  group_by(GMDNR) %>% 
  summarise(deaths = sum(deaths),
            population = sum(population),
            population_mid_poi = sum(population_mid_poi)) %>% 
  ungroup() %>% 
  mutate(pop_diff = population_mid_poi - population,
         perc_diff = (pop_diff / population_mid_poi) * 100)

summary(pop_diff$pop_diff)
summary(pop_diff$perc_diff)

gg21 %<>% 
  left_join(pop_diff)

gg21_centr %<>% 
  left_join(pop_diff)
```

```{r}
gg21 %>% 
  st_drop_geometry() %>% 
  ggplot() +
  geom_histogram(aes(pop_diff))
```

```{r}
gg21 %>% 
  st_drop_geometry() %>% 
  ggplot() +
  geom_histogram(aes(perc_diff))
```

```{r}
gg21 %>% 
  st_drop_geometry() %>% 
  ggplot() +
  geom_point(aes(pop_diff, perc_diff))
```

```{r}
tmap_mode("view")

tm_shape(gg21_centr) +
  tm_bubbles(size = "population_mid_poi", col = "perc_diff",
             style = "fixed", breaks = c(-5, -3, -1, 0, 1, 3, 5.5))
```

<!-- ----------------------------------------------------- -->

# Deaths > pops


```{r}
w_deaths_2015_2021_pop %<>%
  mutate(population_mid_poi = if_else(deaths > population_mid_poi, deaths, population_mid_poi))
```

<!-- ----------------------------------------------------- -->

# Time series plots AR

## Aggregated data 

```{r}
data_agg <- w_deaths_2015_2021_ar_pop %>% 
  mutate(rate = 1000 * deaths / population) %>% 
  group_by(ARNAME, date) %>% 
  summarize(deaths = sum(deaths),
            CDR = weighted.mean(rate, population)) %>% 
  ungroup() 
```

## Deaths

```{r echo=FALSE}
ggplot(data_agg, aes(x = date, y = deaths, group = ARNAME)) + 
  geom_line(colour = "darkorchid", alpha = 0.25) +
  theme_minimal() + 
  ylab("Number of deaths") + xlab("")
```

## Crude mort rates

```{r echo=FALSE}
ggplot(data_agg, aes(x = date, y = CDR, group = ARNAME)) + 
  geom_line(colour = "darkorchid", alpha = 0.25) +
  theme_minimal() + 
  ylab("Crude death rate [per 10,000]") + xlab("")
```

<!-- ----------------------------------------------------- -->

# Tiles AR

## All

```{r echo=FALSE}
ggplot(data_agg, aes(x = date, y = ARNAME, fill = CDR)) + 
  geom_tile(color = "white", size = 0.05) +
  coord_equal(ratio = 50) + 
  scale_fill_viridis_c(option = "E", direction = -1) + 
  theme_minimal() + 
  ylab("") + xlab("")
```

## Selected 

```{r echo=FALSE}
scales <- data_agg %>% 
  filter(ARNAME %in% c("Biasca", "Bern")) %>% 
  summarise(min = min(CDR),
            max = max(CDR))

p1 <- data_agg %>% 
  filter(ARNAME %in% c("Biasca")) %>% 
  ggplot(aes(x = date, y = "Biasca", fill = CDR)) + 
  geom_tile(color = "white", size = 0.05) +
  coord_equal(ratio = 50) + 
  scale_fill_viridis_c(limits = c(scales$min, scales$max),
                       option = "E", direction = -1) + 
  facet_grid(rows = vars(ARNAME)) +
  theme_minimal() + 
  theme(axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.background = element_blank(),
        strip.text.y = element_blank()) +
  ylab("") + xlab("")

p2 <- data_agg %>% 
  filter(ARNAME %in% c("Bern")) %>% 
  ggplot(aes(x = date, y = "Bern", fill = CDR)) + 
  geom_tile(color = "white", size = 0.05) +
  coord_equal(ratio = 50) + 
  scale_fill_viridis_c(limits = c(scales$min, scales$max),
                       option = "E", direction = -1) + 
  facet_grid(rows = vars(ARNAME)) +
  theme_minimal() + 
  theme(axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.background = element_blank(),
        strip.text.y = element_blank()) +
  ylab("") + xlab("")

ggpubr::ggarrange(
  p1, p2,
  ncol = 1,
  common.legend = TRUE, legend = "bottom"
)

rm(data_agg); gc()
```









<!-- ----------------------------------------------------- -->

# Time series plots GEM

## Aggregated data 

```{r}
data <- w_deaths_2015_2021_pop %>% 
  mutate(rate = 1000 * deaths / population) %>% 
  group_by(GMDNAME, date) %>% 
  summarize(deaths = sum(deaths),
            CDR = weighted.mean(rate, population),
            population = sum(population)
  ) %>% 
  ungroup() 
```

## Deaths

```{r echo=FALSE}
ggplot(data, aes(x = date, y = deaths, group = GMDNAME)) + 
  geom_line(colour = "darkorchid", alpha = 0.25) +
  theme_minimal() + 
  ylab("Number of deaths") + xlab("")
```

## Crude mort rates

```{r echo=FALSE}
ggplot(data, aes(x = date, y = CDR, group = GMDNAME)) + 
  geom_line(colour = "darkorchid", alpha = 0.25) +
  theme_minimal() + 
  ylab("Crude death rate [per 10,000]") + xlab("")
```

<!-- ----------------------------------------------------- -->

# Tiles GEM

## Selected 

```{r echo=FALSE}
scales <- data %>% 
  filter(GMDNAME %in% c("Brienzwiler", "Bern")) %>% 
  summarise(min = min(CDR),
            max = max(CDR))

p1 <- data %>% 
  filter(GMDNAME %in% c("Brienzwiler")) %>% 
  ggplot(aes(x = date, y = "Brienzwiler", fill = CDR)) + 
  geom_tile(color = "white", size = 0.05) +
  coord_equal(ratio = 50) + 
  scale_fill_viridis_c(limits = c(scales$min, scales$max),
                       option = "E", direction = -1) + 
  facet_grid(rows = vars(GMDNAME)) +
  theme_minimal() + 
  theme(axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.background = element_blank(),
        strip.text.y = element_blank()) +
  ylab("") + xlab("")

p1 

p2 <- data %>% 
  filter(GMDNAME %in% c("Bern")) %>% 
  ggplot(aes(x = date, y = "Bern", fill = CDR)) + 
  geom_tile(color = "white", size = 0.05) +
  coord_equal(ratio = 50) + 
  scale_fill_viridis_c(limits = c(scales$min, scales$max),
                       option = "E", direction = -1) + 
  facet_grid(rows = vars(GMDNAME)) +
  theme_minimal() + 
  theme(axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.background = element_blank(),
        strip.text.y = element_blank()) +
  ylab("") + xlab("")

ggpubr::ggarrange(
  p1, p2,
  ncol = 1,
  common.legend = TRUE, legend = "bottom"
)
```
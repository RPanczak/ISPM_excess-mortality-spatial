---
title: "Spatial analyses of 2020-21 excess mortality in CH"
subtitle: "Analyses using AR"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, magrittr, scales,  
       DT, 
       sf, tmap)

import::from("sjmisc", "frq")
```


```{r conflicts, include = FALSE}
tidyverse::tidyverse_conflicts()

conflicted::conflict_scout()
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Data 

## Deaths

```{r}
w_deaths_2015_2021_ar_pop <- read_rds("data/BfS-closed/w_deaths_2015_2021_ar_pop.Rds") %>% 
  mutate(time = as.numeric(as.factor(date))) %>% 
  select(-date) %>% relocate(time, .after = month)
```

## Spatial 

```{r}
ar21 <- readRDS("data/BfS/argr21.Rds")
argr21 <- readRDS("data/BfS/argr21.Rds")

tg3o_ar <- readRDS("data/geo/tg3o_ar.Rds")
```

<!-- ----------------------------------------------------- -->

# Time series plots

## Aggregated data 

```{r}
data <- w_deaths_2015_2021_ar_pop %>% 
  mutate(rate = 1000 * deaths / population) %>% 
  group_by(ARNAME, date) %>% 
  summarize(CDR = weighted.mean(rate, population)) %>% 
  ungroup() 
```

## Deaths

```{r echo=FALSE}
ggplot(data, aes(x = date, y = deaths, group = ARNAME)) + 
  geom_line(colour = "darkorchid", alpha = 0.25) +
  theme_minimal() + 
  ylab("Number of deaths") + xlab("")
```

## Crude mort rates

```{r echo=FALSE}
ggplot(data, aes(x = date, y = CDR, group = ARNAME)) + 
  geom_line(colour = "darkorchid", alpha = 0.25) +
  theme_minimal() + 
  ylab("Crude death rate [per 10,000]") + xlab("")
```

<!-- ----------------------------------------------------- -->

# Tiles 

```{r}
ggplot(data, aes(x = date, y = ARNAME, fill = CDR)) + 
  geom_tile(color = "white", size = 0.05) +
  coord_equal(ratio = 50) + 
  scale_fill_viridis_c(option = "E", direction = -1) + 
  theme_minimal() + 
  ylab("") + xlab("")
```




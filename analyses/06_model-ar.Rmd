---
title: "Spatial analyses of 2020-21 excess mortality in CH"
subtitle: "Analyses using AR"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, magrittr, scales,  
       DT, 
       sf, tmap,
       INLA)

import::from("sjmisc", "frq")
```

```{r conflicts, include = FALSE}
tidyverse::tidyverse_conflicts()

conflicted::conflict_scout()
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Data 

## Deaths

```{r}
w_deaths_2015_2021_ar_pop <- read_rds("data/BfS-closed/w_deaths_2015_2021_ar_pop.Rds") %>% 
  mutate(time = as.numeric(as.factor(date))) %>% 
  # select(-date) %>% 
  relocate(time, .after = month)
```

## Spatial 

```{r}
ar21 <- readRDS("data/BfS/argr21.Rds")
argr21 <- readRDS("data/BfS/argr21.Rds")

tg3o_ar <- readRDS("data/geo/tg3o_ar.Rds")
```

## Weights

```{r}
ar21_wm_q_list <- read_rds("data/nb/ar21_wm_q_list.Rds")
```

<!-- ----------------------------------------------------- -->

# Time series plots

## Aggregated data 

```{r}
data <- w_deaths_2015_2021_ar_pop %>% 
  mutate(rate = 1000 * deaths / population) %>% 
  group_by(ARNAME, date) %>% 
  summarize(deaths = sum(deaths),
            CDR = weighted.mean(rate, population)) %>% 
  ungroup() 
```

## Deaths

```{r echo=FALSE}
ggplot(data, aes(x = date, y = deaths, group = ARNAME)) + 
  geom_line(colour = "darkorchid", alpha = 0.25) +
  theme_minimal() + 
  ylab("Number of deaths") + xlab("")
```

## Crude mort rates

```{r echo=FALSE}
ggplot(data, aes(x = date, y = CDR, group = ARNAME)) + 
  geom_line(colour = "darkorchid", alpha = 0.25) +
  theme_minimal() + 
  ylab("Crude death rate [per 10,000]") + xlab("")
```

<!-- ----------------------------------------------------- -->

# Tiles 

## All

```{r echo=FALSE}
ggplot(data, aes(x = date, y = ARNAME, fill = CDR)) + 
  geom_tile(color = "white", size = 0.05) +
  coord_equal(ratio = 50) + 
  scale_fill_viridis_c(option = "E", direction = -1) + 
  theme_minimal() + 
  ylab("") + xlab("")
```

## Selected 

```{r echo=FALSE}
scales <- data %>% 
  filter(ARNAME %in% c("Biasca", "Bern")) %>% 
  summarise(min = min(CDR),
            max = max(CDR))

p1 <- data %>% 
  filter(ARNAME %in% c("Biasca")) %>% 
  ggplot(aes(x = date, y = "Biasca", fill = CDR)) + 
  geom_tile(color = "white", size = 0.05) +
  coord_equal(ratio = 50) + 
  scale_fill_viridis_c(limits = c(scales$min, scales$max),
                       option = "E", direction = -1) + 
  facet_grid(rows = vars(ARNAME)) +
  theme_minimal() + 
  theme(axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.background = element_blank(),
        strip.text.y = element_blank()) +
  ylab("") + xlab("")

p2 <- data %>% 
  filter(ARNAME %in% c("Bern")) %>% 
  ggplot(aes(x = date, y = "Bern", fill = CDR)) + 
  geom_tile(color = "white", size = 0.05) +
  coord_equal(ratio = 50) + 
  scale_fill_viridis_c(limits = c(scales$min, scales$max),
                       option = "E", direction = -1) + 
  facet_grid(rows = vars(ARNAME)) +
  theme_minimal() + 
  theme(axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.background = element_blank(),
        strip.text.y = element_blank()) +
  ylab("") + xlab("")

ggpubr::ggarrange(
  p1, p2,
  ncol = 1,
  common.legend = TRUE, legend = "bottom"
  )
```

<!-- ----------------------------------------------------- -->

# Simple modelling

## Data

Using only data until 2019-12.  

```{r}
model_data = w_deaths_2015_2021_ar_pop %>% 
  filter(year < 2020) %>% 
  filter(age != "<40")
```

## INLA setup

```{r}
# prior
hyper.iid <- list(theta = list(prior = "pc.prec", param = c(1, 0.01)))

# Under Poisson uses default set up
control.family <- inla.set.control.family.default()
```

## Simple time

```{r}
f1 <-
  deaths ~ 1 + offset(log(population)) + 
  sex + age + 
  f(time, model = "rw2", hyper = hyper.iid, constr = TRUE, scale.model = TRUE) +
  f(ARNR, model = "iid", hyper = hyper.iid, constr = TRUE)

m1 <- inla(f1,
           data = model_data,
           family = "Poisson",
           # verbose = TRUE,
           control.family = control.family,
           control.compute = list(config = TRUE, dic = TRUE, waic = TRUE),
           control.mode = list(restart = TRUE),
           num.threads = round(parallel::detectCores() * .8),
           control.predictor = list(link = 1)
)

summary(m1)

exp(m1$summary.fixed)
m1$summary.random
m1$summary.hyperpar

m1$summary.linear.predictor
# m1$marginals.linear.predictor

m1$summary.fitted.values
# m1$marginals.fitted.values

marg.variance <- inla.tmarginal(function(x) 1/x,
                                m1$marginals.hyperpar$"Precision for ARNR")
mm <- inla.emarginal(function(x) x^2, marg.variance)
m <- inla.emarginal(function(x) x, marg.variance)
sqrt(mm - m^2)

m1_time <- m1$summary.random$time

ggplot(m1_time, aes(x = ID)) + 
  geom_ribbon(aes(ymin = `0.025quant`, ymax = `0.975quant`), alpha = 0.1) + 
  geom_line(aes(y = `0.5quant`)) + 
  theme_minimal()

m1_fit <- m1$summary.fitted.values
m1_fit$obs <- model_data$deaths

ggplot(m1_fit) + 
  geom_point(aes(x = `0.5quant`, y = obs), alpha = 0.22) + 
  theme_minimal()
```

## Adding months

```{r}
f2 <-
  deaths ~ 1 + offset(log(population)) + 
  sex + age + 
  f(time, model = "rw2", hyper = hyper.iid, constr = TRUE, scale.model = TRUE) +
  f(month, model = "rw1", hyper = hyper.iid, constr = TRUE, scale.model = TRUE,
    cyclic = TRUE)  +
  f(ARNR, model = "iid", hyper = hyper.iid, constr = TRUE)

m2 <- inla(f2,
           data = model_data,
           family = "Poisson",
           # verbose = TRUE,
           control.family = control.family,
           control.compute = list(config = TRUE, dic = TRUE, waic = TRUE),
           control.mode = list(restart = TRUE),
           num.threads = round(parallel::detectCores() * .8),
           control.predictor = list(link = 1)
)

summary(m2)

exp(m2$summary.fixed)
m2$summary.random
m2$summary.hyperpar

m2$summary.linear.predictor
# m2$marginals.linear.predictor

m2$summary.fitted.values
# m2$marginals.fitted.values

marg.variance <- inla.tmarginal(function(x) 1/x,
                                m2$marginals.hyperpar$"Precision for ARNR")
mm <- inla.emarginal(function(x) x^2, marg.variance)
m <- inla.emarginal(function(x) x, marg.variance)
sqrt(mm - m^2)

m2_time <- m2$summary.random$time

ggplot(m2_time, aes(x = ID)) + 
  geom_ribbon(aes(ymin = `0.025quant`, ymax = `0.975quant`), alpha = 0.1) + 
  geom_line(aes(y = `0.5quant`)) + 
  theme_minimal()

m2_month <- m2$summary.random$month

ggplot(m2_month, aes(x = ID)) + 
  geom_ribbon(aes(ymin = `0.025quant`, ymax = `0.975quant`), alpha = 0.1) + 
  geom_line(aes(y = `0.5quant`)) + 
  theme_minimal()

m2_fit <- m2$summary.fitted.values
m2_fit$obs <- model_data$deaths

ggplot(m2_fit) + 
  geom_point(aes(x = `0.5quant`, y = obs), alpha = 0.22) + 
  theme_minimal()
```

## Adding canton

```{r}
f3 <-
  deaths ~ 1 + offset(log(population)) + 
  sex + age + 
  f(time, model = "rw2", hyper = hyper.iid, constr = TRUE, scale.model = TRUE) +
  f(month, model = "rw1", hyper = hyper.iid, constr = TRUE, scale.model = TRUE,
    cyclic = TRUE)  +
  f(ARNR, model = "iid", hyper = hyper.iid, constr = TRUE) + 
  f(KTNAME, model = "iid", hyper = hyper.iid, constr = TRUE)

m3 <- inla(f3,
           data = model_data,
           family = "Poisson",
           # verbose = TRUE,
           control.family = control.family,
           control.compute = list(config = TRUE, dic = TRUE, waic = TRUE),
           control.mode = list(restart = TRUE),
           num.threads = round(parallel::detectCores() * .8),
           control.predictor = list(link = 1)
)

summary(m3)

m3$summary.fixed
m3$summary.random
m3$summary.hyperpar

m3$summary.linear.predictor
# m3$marginals.linear.predictor

m3$summary.fitted.values
# m3$marginals.fitted.values

marg.variance <- inla.tmarginal(function(x) 1/x,
                                m3$marginals.hyperpar$"Precision for ARNR")
mm <- inla.emarginal(function(x) x^2, marg.variance)
m <- inla.emarginal(function(x) x, marg.variance)
sqrt(mm - m^2)

m3_time <- m3$summary.random$time

ggplot(m3_time, aes(x = ID)) + 
  geom_ribbon(aes(ymin = `0.025quant`, ymax = `0.975quant`), alpha = 0.1) + 
  geom_line(aes(y = `0.5quant`)) + 
  theme_minimal()

m3_month <- m3$summary.random$month

ggplot(m3_month, aes(x = ID)) + 
  geom_ribbon(aes(ymin = `0.025quant`, ymax = `0.975quant`), alpha = 0.1) + 
  geom_line(aes(y = `0.5quant`)) + 
  theme_minimal()

m3_fit <- m3$summary.fitted.values
m3_fit$obs <- model_data$deaths

ggplot(m3_fit) + 
  geom_point(aes(x = `0.5quant`, y = obs), alpha = 0.22) + 
  theme_minimal()
```

```{r}
dotchart(
  c(
    m1$dic$dic,
    m2$dic$dic,
    m3$dic$dic
  ), labels = c(
    "m1", "m2", "m3"
  )
)

dotchart(
  c(
    m1$waic$waic,
    m2$waic$waic,
    m3$waic$waic
  ), labels = c(
    "m1", "m2", "m3"
  )
)

```

